<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAWGraphs Branded Chart Demo</title>

  <!-- Import brand fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@300;400;500;600&family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Lexend Deca', sans-serif;
      background: #f0f0f0;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
    }

    h1 {
      font-family: 'Lora', serif;
      color: #1a3a5c;
      text-align: center;
    }

    .description {
      max-width: 800px;
      text-align: center;
      color: #4a5568;
      line-height: 1.6;
    }

    .chart-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 20px;
    }

    #branded-chart {
      display: block;
    }

    .controls {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      font-family: 'Lexend Deca', sans-serif;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    button.primary {
      background: #3D7BB9;
      color: white;
    }

    button.primary:hover {
      background: #2c5a8a;
    }

    button.secondary {
      background: #E8A838;
      color: white;
    }

    button.secondary:hover {
      background: #c88c2c;
    }

    .code-section {
      max-width: 900px;
      width: 100%;
    }

    .code-section h2 {
      font-family: 'Lora', serif;
      color: #1a3a5c;
      margin-bottom: 16px;
    }

    pre {
      background: #1a3a5c;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
    }

    code {
      font-family: 'Monaco', 'Consolas', monospace;
    }
  </style>
</head>
<body>
  <h1>RAWGraphs Branded Chart Demo</h1>

  <p class="description">
    This demo shows how RAWGraphs-Charts can be customized to produce branded chart output
    with custom fonts (Lora for titles, Lexend Deca for body text), brand colors,
    and a consistent visual frame including title, sources, and logos.
  </p>

  <div class="controls">
    <button class="primary" onclick="downloadSVG()">Download SVG</button>
    <button class="secondary" onclick="downloadPNG()">Download PNG</button>
  </div>

  <div class="chart-container">
    <svg id="branded-chart" width="1080" height="1080"></svg>
  </div>

  <div class="code-section">
    <h2>How It Works</h2>
    <pre><code>import { latinometricsTheme, createBrandedFrame, generateStyles } from '@rawgraphs/rawgraphs-charts/branding'
import { barchart } from '@rawgraphs/rawgraphs-charts'

// 1. Configure the branded frame
const frameConfig = {
  width: 1080,
  height: 1080,
  background: '#FAF5F0',
  title: {
    text: 'Sectores manufactureros\nimpulsando la IA en MÃ©xico',
    style: {
      fontFamily: "'Lora', serif",
      fontSize: 42,
      fontWeight: 700,
      fill: '#1a3a5c',
    },
  },
  sources: { text: 'Fuentes: INEGI, Eurostat' },
  legend: {
    show: true,
    items: [
      { color: '#3D7BB9', label: 'Empresas con 11 a 250 empleados' },
      { color: '#E8A838', label: 'Empresas con mÃ¡s de 250 empleados' },
    ],
  },
}

// 2. Create the branded frame
const frame = createBrandedFrame(frameConfig)

// 3. Render chart into the frame's chart container
const chartContainer = frame.querySelector('#chart-container')
barchart.render(chartContainer, data, visualOptions, mapping, originalData, brandedStyles)</code></pre>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // ============================================================
    // Inline BrandedFrame module (mirrors src/branding/BrandedFrame.js)
    // In production, import from '@rawgraphs/rawgraphs-charts/branding'
    // ============================================================

    let clipIdCounter = 0

    /**
     * Create a branded frame SVG element
     * This is a simplified inline version of the library's createBrandedFrame function
     */
    function createBrandedFrame(config = {}) {
      const defaults = {
        width: 1080,
        height: 1080,
        padding: { top: 140, right: 40, bottom: 120, left: 40 },
        background: '#FAF5F0',
        title: { text: '', x: 40, y: 50, style: { fontFamily: "'Lora', Georgia, serif", fontSize: 42, fontWeight: 700, fill: '#1a3a5c' } },
        subtitle: { text: '', x: 40, y: 100, style: { fontFamily: "'Lexend Deca', sans-serif", fontSize: 16, fontWeight: 400, fill: '#4a5568' } },
        flag: { show: false, url: '', x: null, y: 40, width: 50, height: 50, borderRadius: 25 },
        sources: { text: '', x: 40, y: null, style: { fontFamily: "'Lexend Deca', sans-serif", fontSize: 12, fontWeight: 400, fill: '#718096' } },
        logos: [],
        legend: { show: false, x: null, y: null, width: 280, padding: 15, background: 'white', borderRadius: 4, border: '#e2e8f0', title: '', items: [] },
      }

      const cfg = { ...defaults, ...config }
      cfg.padding = { ...defaults.padding, ...config.padding }
      cfg.title = { ...defaults.title, ...config.title, style: { ...defaults.title.style, ...(config.title?.style || {}) } }
      cfg.sources = { ...defaults.sources, ...config.sources, style: { ...defaults.sources.style, ...(config.sources?.style || {}) } }
      cfg.flag = { ...defaults.flag, ...config.flag }
      cfg.legend = { ...defaults.legend, ...config.legend }

      // Create SVG
      const svg = d3.create('svg')
        .attr('xmlns', 'http://www.w3.org/2000/svg')
        .attr('width', cfg.width)
        .attr('height', cfg.height)
        .attr('viewBox', `0 0 ${cfg.width} ${cfg.height}`)

      // Add font import
      svg.append('style')
        .text("@import url('https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@300;400;500;600&family=Lora:wght@400;500;600;700&display=swap');")

      // Background
      svg.append('rect')
        .attr('id', 'frame-background')
        .attr('width', cfg.width)
        .attr('height', cfg.height)
        .attr('fill', cfg.background)

      // Title (with multi-line support)
      if (cfg.title.text) {
        const titleGroup = svg.append('g').attr('id', 'title-group')
        const titleLines = cfg.title.text.split('\n')
        const lineHeight = cfg.title.style.fontSize * 1.2

        titleLines.forEach((line, i) => {
          titleGroup.append('text')
            .attr('class', 'chart-title')
            .attr('x', cfg.title.x)
            .attr('y', cfg.title.y + (i * lineHeight))
            .style('font-family', cfg.title.style.fontFamily)
            .style('font-size', `${cfg.title.style.fontSize}px`)
            .style('font-weight', cfg.title.style.fontWeight)
            .style('fill', cfg.title.style.fill)
            .text(line)
        })
      }

      // Flag/icon
      if (cfg.flag.show && cfg.flag.url) {
        const flagX = cfg.flag.x !== null ? cfg.flag.x : cfg.width - cfg.padding.right - cfg.flag.width
        const flagGroup = svg.append('g')
          .attr('id', 'flag-group')
          .attr('transform', `translate(${flagX}, ${cfg.flag.y})`)

        if (cfg.flag.borderRadius) {
          const clipId = `flag-clip-${clipIdCounter++}`
          svg.append('defs')
            .append('clipPath')
            .attr('id', clipId)
            .append('circle')
            .attr('cx', cfg.flag.width / 2)
            .attr('cy', cfg.flag.height / 2)
            .attr('r', cfg.flag.borderRadius)

          flagGroup.append('image')
            .attr('href', cfg.flag.url)
            .attr('width', cfg.flag.width)
            .attr('height', cfg.flag.height)
            .attr('clip-path', `url(#${clipId})`)
        } else {
          flagGroup.append('image')
            .attr('href', cfg.flag.url)
            .attr('width', cfg.flag.width)
            .attr('height', cfg.flag.height)
        }
      }

      // Chart container
      const chartX = cfg.padding.left
      const chartY = cfg.padding.top
      const chartWidth = cfg.width - cfg.padding.left - cfg.padding.right
      const chartHeight = cfg.height - cfg.padding.top - cfg.padding.bottom

      svg.append('g')
        .attr('id', 'chart-container')
        .attr('transform', `translate(${chartX}, ${chartY})`)
        .attr('data-width', chartWidth)
        .attr('data-height', chartHeight)

      // Legend box (with multi-line title support)
      if (cfg.legend.show && cfg.legend.items.length > 0) {
        const legendX = cfg.legend.x !== null ? cfg.legend.x : cfg.width - cfg.padding.right - cfg.legend.width - 20
        const legendY = cfg.legend.y !== null ? cfg.legend.y : cfg.height - cfg.padding.bottom - 100

        const legendGroup = svg.append('g')
          .attr('id', 'legend-box')
          .attr('transform', `translate(${legendX}, ${legendY})`)

        const itemHeight = 24
        const titleLineHeight = 18
        const titleLines = cfg.legend.title ? cfg.legend.title.split('\n') : []
        const titleHeight = titleLines.length > 0 ? (titleLines.length * titleLineHeight) + 10 : 0
        const legendHeight = cfg.legend.padding * 2 + titleHeight + (cfg.legend.items.length * itemHeight)

        // Background
        legendGroup.append('rect')
          .attr('width', cfg.legend.width)
          .attr('height', legendHeight)
          .attr('fill', cfg.legend.background)
          .attr('stroke', cfg.legend.border)
          .attr('stroke-width', 1)
          .attr('rx', cfg.legend.borderRadius)

        // Title with tspan for multi-line
        if (cfg.legend.title) {
          const titleText = legendGroup.append('text')
            .attr('x', cfg.legend.padding)
            .attr('y', cfg.legend.padding + 14)
            .style('font-family', "'Lexend Deca', sans-serif")
            .style('font-size', '12px')
            .style('font-weight', 600)
            .style('fill', '#2d3748')

          titleLines.forEach((line, i) => {
            titleText.append('tspan')
              .attr('x', cfg.legend.padding)
              .attr('dy', i === 0 ? 0 : '1.4em')
              .text(line)
          })
        }

        // Legend items
        const itemsGroup = legendGroup.append('g')
          .attr('transform', `translate(${cfg.legend.padding}, ${cfg.legend.padding + titleHeight})`)

        cfg.legend.items.forEach((item, i) => {
          const itemG = itemsGroup.append('g')
            .attr('transform', `translate(0, ${i * itemHeight})`)

          itemG.append('rect')
            .attr('width', 30)
            .attr('height', 12)
            .attr('y', 2)
            .attr('fill', item.color)
            .attr('rx', 2)

          itemG.append('text')
            .attr('x', 40)
            .attr('y', 12)
            .style('font-family', "'Lexend Deca', sans-serif")
            .style('font-size', '11px')
            .style('fill', '#4a5568')
            .text(item.label)
        })
      }

      // Sources
      if (cfg.sources.text) {
        const sourcesY = cfg.sources.y !== null ? cfg.sources.y : cfg.height - 50
        svg.append('text')
          .attr('id', 'sources-text')
          .attr('x', cfg.sources.x)
          .attr('y', sourcesY)
          .style('font-family', cfg.sources.style.fontFamily)
          .style('font-size', `${cfg.sources.style.fontSize}px`)
          .style('font-weight', cfg.sources.style.fontWeight)
          .style('fill', cfg.sources.style.fill)
          .text(cfg.sources.text)
      }

      // Logos
      if (cfg.logos && cfg.logos.length > 0) {
        const logosGroup = svg.append('g').attr('id', 'logos-group')
        cfg.logos.forEach((logo) => {
          const logoX = logo.x !== null ? logo.x : cfg.width - cfg.padding.right - logo.width
          const logoY = logo.y !== null ? logo.y : cfg.height - 45
          logosGroup.append('image')
            .attr('href', logo.url)
            .attr('x', logoX)
            .attr('y', logoY)
            .attr('width', logo.width)
            .attr('height', logo.height || 'auto')
        })
      }

      return svg.node()
    }

    // ============================================================
    // Demo data and configuration
    // ============================================================

    // Sample data for the chart
    const data = [
      { sector: 'Bebidas y tabaco', small: 9, large: 33 },
      { sector: 'Promedio de manufactura de la UE', small: null, large: 32, isHighlight: true },
      { sector: 'ElectrÃ³nica y computadoras', small: 8, large: 28 },
      { sector: 'Equipo elÃ©ctrico', small: 8, large: 27 },
      { sector: 'Productos minerales no metÃ¡licos', small: 7, large: 25 },
      { sector: 'PetrÃ³leo y carbÃ³n', small: 6, large: 24 },
      { sector: 'Papel', small: 6, large: 22 },
      { sector: 'Productos textiles', small: 6, large: 21 },
      { sector: 'Equipo de transporte', small: 5, large: 20 },
      { sector: 'Promedio de manufactura en MÃ©xico', small: null, large: 18, isHighlight: true },
      { sector: 'Maquinaria', small: 5, large: 17 },
      { sector: 'PlÃ¡sticos y caucho', small: 5, large: 16 },
      { sector: 'Comida', small: 5, large: 15 },
      { sector: 'QuÃ­micos', small: 4, large: 14 },
      { sector: 'Otras manufacturas', small: 4, large: 13 },
      { sector: 'Metal fabricado', small: 4, large: 12 },
      { sector: 'ImpresiÃ³n', small: 3, large: 10 },
      { sector: 'Metales Primarios', small: 3, large: 9 },
      { sector: 'Cuero & pieles', small: 3, large: 8 },
      { sector: 'FÃ¡bricas textiles', small: 2, large: 7 },
      { sector: 'Ropa y vestimenta', small: 2, large: 6 },
      { sector: 'Muebles', small: 2, large: 5 },
      { sector: 'Productos de madera', small: 1, large: 4 },
    ]

    // Brand colors
    const colors = {
      primary: '#3D7BB9',      // Blue
      accent: '#E8A838',       // Orange
      background: '#FAF5F0',   // Cream
      text: '#1a3a5c',
      textMuted: '#4a5568',
      textLight: '#718096',
    }

    // Frame configuration using the library pattern
    const frameConfig = {
      width: 1080,
      height: 1080,
      padding: { top: 150, right: 360, bottom: 80, left: 40 },
      background: colors.background,

      title: {
        text: 'Sectores manufactureros\nimpulsando la IA en MÃ©xico',
        x: 40,
        y: 55,
        style: {
          fontFamily: "'Lora', Georgia, serif",
          fontSize: 42,
          fontWeight: 700,
          fill: colors.text,
        },
      },

      flag: {
        show: true,
        url: 'https://flagcdn.com/w80/mx.png',
        y: 40,
        width: 50,
        height: 50,
        borderRadius: 25,
      },

      sources: {
        text: 'Fuentes: INEGI, Eurostat',
        x: 40,
        style: { fill: colors.textLight },
      },

      logos: [
        { url: 'assets/latinometrics-logo.png', width: 180, height: 40, x: 760, y: 1025 },
      ],

      legend: {
        show: true,
        x: 740,
        y: 620,
        width: 300,
        padding: 15,
        background: 'white',
        borderRadius: 4,
        border: '#e2e8f0',
        title: 'AdopciÃ³n de IA en los\nsubsectores manufactureros\nde MÃ©xico\n(encuesta de 2024)',
        items: [
          { color: colors.primary, label: 'Empresas con 11 a 250 empleados' },
          { color: colors.accent, label: 'Empresas con mÃ¡s de 250 empleados' },
        ],
      },
    }

    /**
     * Render the chart content into a chart container
     * This demonstrates how you would render your chart into the frame's container
     */
    function renderChartContent(container, chartWidth, chartHeight) {
      const g = d3.select(container)

      // Scales
      const yScale = d3.scaleBand()
        .domain(data.map(d => d.sector))
        .range([0, chartHeight])
        .padding(0.35)

      const xScale = d3.scaleLinear()
        .domain([0, 35])
        .range([0, chartWidth])

      // Grid lines
      const ticks = [5, 10, 15, 20, 25, 30, 35]
      const gridGroup = g.append('g').attr('class', 'grid')

      ticks.forEach(tick => {
        gridGroup.append('line')
          .attr('x1', xScale(tick))
          .attr('x2', xScale(tick))
          .attr('y1', 0)
          .attr('y2', chartHeight)
          .attr('stroke', '#e2e8f0')
          .attr('stroke-dasharray', '2,2')
      })

      // X-axis labels
      const xAxisGroup = g.append('g')
        .attr('transform', `translate(0, ${chartHeight})`)

      ticks.forEach(tick => {
        xAxisGroup.append('text')
          .attr('x', xScale(tick))
          .attr('y', 20)
          .attr('text-anchor', 'middle')
          .style('font-family', "'Lexend Deca', sans-serif")
          .style('font-size', '10px')
          .style('fill', colors.textMuted)
          .text(tick + '%')
      })

      xAxisGroup.append('text')
        .attr('x', chartWidth / 2)
        .attr('y', 45)
        .attr('text-anchor', 'middle')
        .style('font-family', "'Lexend Deca', sans-serif")
        .style('font-size', '11px')
        .style('fill', colors.textMuted)
        .text('% de empresas que informan usar Inteligencia Artificial')

      // Bars and labels
      const barsGroup = g.append('g').attr('class', 'bars')

      data.forEach(d => {
        const y = yScale(d.sector)
        const barHeight = yScale.bandwidth() / 2.2

        if (d.large !== null) {
          barsGroup.append('rect')
            .attr('x', 0)
            .attr('y', y + barHeight * 0.1)
            .attr('width', xScale(d.large))
            .attr('height', barHeight)
            .attr('fill', colors.accent)
        }

        if (d.small !== null) {
          barsGroup.append('rect')
            .attr('x', 0)
            .attr('y', y + barHeight * 1.1)
            .attr('width', xScale(d.small))
            .attr('height', barHeight)
            .attr('fill', colors.primary)
        }

        const isHighlight = d.isHighlight
        barsGroup.append('text')
          .attr('x', Math.max(xScale(d.large || d.small || 0), 0) + 8)
          .attr('y', y + yScale.bandwidth() / 2)
          .attr('dominant-baseline', 'middle')
          .style('font-family', "'Lexend Deca', sans-serif")
          .style('font-size', '11px')
          .style('font-weight', isHighlight ? '600' : '400')
          .style('fill', colors.text)
          .text(d.sector)

        if (isHighlight) {
          const iconX = Math.max(xScale(d.large || 0), 0) - 20
          barsGroup.append('text')
            .attr('x', iconX)
            .attr('y', y + yScale.bandwidth() / 2)
            .attr('dominant-baseline', 'middle')
            .style('font-size', '14px')
            .text(d.sector.includes('UE') ? 'ðŸ‡ªðŸ‡º' : 'ðŸ‡²ðŸ‡½')
        }
      })
    }

    /**
     * Main render function using createBrandedFrame
     */
    function renderBrandedChart() {
      const targetSvg = document.getElementById('branded-chart')

      // Clear existing content
      targetSvg.innerHTML = ''

      // 1. Create the branded frame using the library function
      const frame = createBrandedFrame(frameConfig)

      // 2. Copy frame content to target SVG
      while (frame.firstChild) {
        targetSvg.appendChild(frame.firstChild)
      }

      // 3. Set SVG attributes
      targetSvg.setAttribute('width', frameConfig.width)
      targetSvg.setAttribute('height', frameConfig.height)
      targetSvg.setAttribute('viewBox', `0 0 ${frameConfig.width} ${frameConfig.height}`)

      // 4. Find the chart container and render chart content into it
      const chartContainer = targetSvg.querySelector('#chart-container')
      const chartWidth = parseInt(chartContainer.getAttribute('data-width'))
      const chartHeight = parseInt(chartContainer.getAttribute('data-height'))

      renderChartContent(chartContainer, chartWidth, chartHeight)
    }

    // Download SVG
    function downloadSVG() {
      const svg = document.getElementById('branded-chart')
      const serializer = new XMLSerializer()
      let source = serializer.serializeToString(svg)

      // Add XML declaration
      source = '<?xml version="1.0" encoding="UTF-8"?>\n' + source

      const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' })
      const url = URL.createObjectURL(blob)

      const link = document.createElement('a')
      link.href = url
      link.download = 'branded-chart.svg'
      link.click()

      URL.revokeObjectURL(url)
    }

    // Download PNG
    function downloadPNG() {
      const svg = document.getElementById('branded-chart')
      const canvas = document.createElement('canvas')
      const ctx = canvas.getContext('2d')

      canvas.width = 1080 * 2  // 2x for retina
      canvas.height = 1080 * 2
      ctx.scale(2, 2)

      const serializer = new XMLSerializer()
      const source = serializer.serializeToString(svg)
      const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' })
      const url = URL.createObjectURL(blob)

      const img = new Image()
      img.onload = function() {
        ctx.fillStyle = colors.background
        ctx.fillRect(0, 0, canvas.width, canvas.height)
        ctx.drawImage(img, 0, 0)

        canvas.toBlob(function(blob) {
          const pngUrl = URL.createObjectURL(blob)
          const link = document.createElement('a')
          link.href = pngUrl
          link.download = 'branded-chart.png'
          link.click()
          URL.revokeObjectURL(pngUrl)
        }, 'image/png')

        URL.revokeObjectURL(url)
      }
      img.src = url
    }

    // Render on load
    renderBrandedChart()
  </script>
</body>
</html>
